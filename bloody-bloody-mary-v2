// You'll need to enable the Google Sheets API and set up OpenAI API access
Version 2 (Recommended) - With Memory for Better Variety
function generateTweets() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const rows = sheet.getDataRange().getValues();
  
  // Replace with your OpenAI API key
  const OPENAI_API_KEY = 'your-api-key-here';
  const BASE_URL = 'https://api.openai.com/v1/chat/completions';
  
  // Store previously generated content for variety
  let previousContent = [];
  
  rows.forEach((row, index) => {
    // Skip header row and empty rows
    if (index === 0 || !row[0] || !row[1] || !row[2] || !row[3]) return;
    
    const restaurantName = row[0];
    const voiceToneStyle = row[1];
    const theme = row[2];
    const details = row[3];
    
    // Common words to avoid in restaurant copy
    const avoidWords = "Do not use the words 'embark', 'elevate', 'elevating', 'dive into', 'rise and shine', 'sip into' or 'nestled'.";
    
    // Include previous content context to avoid repetition
    const previousContentPrompt = previousContent.length > 0
      ? `Avoid repeating these themes or phrasings from previous posts: ${previousContent.join(", ")}. `
      : '';
    
    const prompt = `You are the social media manager for "${restaurantName}", a restaurant known for its ${voiceToneStyle}. 
      Compose a unique and original tweet about "${theme}" that incorporates these details: "${details}" 
      without using emojis or hashtags. ${avoidWords} ${previousContentPrompt}
      Ensure this post is distinct from any previous content.`;
    
    try {
      const response = UrlFetchApp.fetch(BASE_URL, {
        method: 'post',
        contentType: 'application/json',
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`
        },
        muteHttpExceptions: true,
        payload: JSON.stringify({
          model: "gpt-4",
          messages: [{
            'role': 'system',
            'content': 'You are an AI designed to help with restaurant social media creative. You write fun, clever posts with attention-grabbing first sentences. ' + avoidWords
          }, {
            'role': 'user',
            'content': prompt
          }],
          temperature: 0.8
        })
      });
      
      const jsonResponse = JSON.parse(response.getContentText());
      
      if (response.getResponseCode() === 200 && jsonResponse.choices && jsonResponse.choices.length > 0) {
        const generatedContent = jsonResponse.choices[0].message.content.trim();
        sheet.getRange(index + 1, 5).setValue(generatedContent);
        
        // Add the generated content to the previousContent array
        previousContent.push(generatedContent);
        
        // Keep only the last 7 generated posts to avoid making the prompt too long
        if (previousContent.length > 7) {
          previousContent.shift();
        }
      } else {
        console.error('Failed to generate tweet for row: ' + (index + 1), jsonResponse);
      }
      
      // Add a small delay between API calls to avoid rate limiting
      Utilities.sleep(1000);
      
    } catch (error) {
      console.error('Error generating content for row: ' + (index + 1), error);
      sheet.getRange(index + 1, 5).setValue('Error: ' + error.message);
    }
  });
}
